锘縖{"name_path": "GameTurnSystem", "kind": "Class", "body_location": {"start_line": 14, "end_line": 124}, "body": "public sealed class GameTurnSystem : IGameTurnSystem\n{\n    private readonly IEventEngine _eventEngine;\n    private readonly IAICoordinator _aiCoordinator;\n    private readonly IEventBus _eventBus;\n    private readonly ITime _time;\n    private bool _firstTurnStarted;\n\n    public GameTurnSystem(\n        IEventEngine eventEngine,\n        IAICoordinator aiCoordinator,\n        IEventBus eventBus,\n        ITime time)\n    {\n        _eventEngine = eventEngine;\n        _aiCoordinator = aiCoordinator;\n        _eventBus = eventBus;\n        _time = time;\n        _firstTurnStarted = false;\n    }\n\n    public GameTurnState StartNewWeek(string saveId)\n    {\n        // Validate SaveId using whitelist pattern [a-zA-Z0-9_-]{1,64}\n        if (!SaveIdValue.TryCreate(saveId, out var validatedSaveId))\n        {\n            throw new ArgumentException(\n                $\"Invalid SaveId '{saveId}'. Must match [a-zA-Z0-9_-]{{1,64}}\",\n                nameof(saveId));\n        }\n\n        return new GameTurnState(\n            Week: 1,\n            Phase: GameTurnPhase.Resolution,\n            SaveId: validatedSaveId!,\n            CurrentTime: System.DateTimeOffset.UtcNow\n        );\n    }\n\n    public async Task<GameTurnState> Advance(GameTurnState state)\n    {\n        // Publish GameTurnStarted event only on first turn\n        if (!_firstTurnStarted)\n        {\n            _firstTurnStarted = true;\n            var startedEvent = WrapEvent(new GameTurnStarted(\n                SaveId: state.SaveId,\n                Week: state.Week,\n                Phase: state.Phase.ToString(),\n                StartedAt: DateTimeOffset.UtcNow\n            ), GameTurnStarted.EventType);\n            await _eventBus.PublishAsync(startedEvent);\n        }\n\n        var nextState = state.Phase switch\n        {\n            GameTurnPhase.Resolution => await _eventEngine.ExecuteResolutionPhaseAsync(state) with\n            {\n                Phase = GameTurnPhase.Player\n            },\n            GameTurnPhase.Player => await _eventEngine.ExecutePlayerPhaseAsync(state) with\n            {\n                Phase = GameTurnPhase.AiSimulation\n            },\n            GameTurnPhase.AiSimulation => await _eventEngine.ExecuteAiPhaseAsync(state) with\n            {\n                Phase = GameTurnPhase.Resolution,\n                Week = state.Week + 1\n            },\n            _ => state\n        };\n\n        // Publish phase changed event if phase transitioned\n        if (nextState.Phase != state.Phase && nextState.Week == state.Week)\n        {\n            var phaseChangedEvent = WrapEvent(new GameTurnPhaseChanged(\n                SaveId: state.SaveId,\n                Week: state.Week,\n                PreviousPhase: state.Phase.ToString(),\n                CurrentPhase: nextState.Phase.ToString(),\n                ChangedAt: DateTimeOffset.UtcNow\n            ), GameTurnPhaseChanged.EventType);\n            await _eventBus.PublishAsync(phaseChangedEvent);\n        }\n\n        // Publish week advanced event if week incremented\n        if (nextState.Week > state.Week)\n        {\n            var weekAdvancedEvent = WrapEvent(new GameWeekAdvanced(\n                SaveId: state.SaveId,\n                PreviousWeek: state.Week,\n                CurrentWeek: nextState.Week,\n                AdvancedAt: DateTimeOffset.UtcNow\n            ), GameWeekAdvanced.EventType);\n            await _eventBus.PublishAsync(weekAdvancedEvent);\n        }\n\n        return nextState;\n    }\n\n    private static DomainEvent WrapEvent(object data, string eventType)\n    {\n        return new DomainEvent(\n            Type: eventType,\n            Source: \"GameTurnSystem\",\n            Data: data,\n            Timestamp: DateTime.UtcNow,\n            Id: Guid.NewGuid().ToString()\n        );\n    }\n}", "relative_path": "Game.Core\\Engine\\GameTurnSystem.cs"}, {"name_path": "GameTurnSystem/GameTurnSystem", "kind": "Method", "body_location": {"start_line": 22, "end_line": 33}, "body": "public GameTurnSystem(\n        IEventEngine eventEngine,\n        IAICoordinator aiCoordinator,\n        IEventBus eventBus,\n        ITime time)\n    {\n        _eventEngine = eventEngine;\n        _aiCoordinator = aiCoordinator;\n        _eventBus = eventBus;\n        _time = time;\n        _firstTurnStarted = false;\n    }", "relative_path": "Game.Core\\Engine\\GameTurnSystem.cs"}]
