锘縶"Game.Core\\Domain\\Turn\\GameTurnState.cs": ["...   6:    int Week,\n...   7:    GameTurnPhase Phase,\n  >   8:    SaveIdValue SaveId,\n...   9:    DateTimeOffset CurrentTime\n...  10:);\n...  11:"], "Game.Core\\Domain\\Turn\\SaveIdValue.cs": ["...  12:/// Allowed characters are [a-zA-Z0-9_-] with a maximum length of 64.\n...  13:/// </remarks>\n  >  14:public sealed record SaveIdValue\n...  15:{\n...  16:    private static readonly Regex ValidPattern =\n...  17:        new(\"^[a-zA-Z0-9_-]{1,64}$\", RegexOptions.Compiled);\n...  18:\n...  19:    /// <summary>", "...  23:\n...  24:    /// <summary>\n  >  25:    /// Creates a new validated SaveIdValue instance.\n...  26:    /// </summary>\n...  27:    /// <param name=\"value\">Raw save identifier string.</param>\n...  28:    /// <exception cref=\"ArgumentException\">\n...  29:    /// Thrown when the value is null, whitespace, too long or contains invalid characters.\n...  30:    /// </exception>", "...  29:    /// Thrown when the value is null, whitespace, too long or contains invalid characters.\n...  30:    /// </exception>\n  >  31:    public SaveIdValue(string value)\n...  32:    {\n...  33:        if (string.IsNullOrWhiteSpace(value))\n...  34:            throw new ArgumentException(\"SaveId cannot be null or whitespace.\", nameof(value));\n...  35:\n...  36:        if (!ValidPattern.IsMatch(value))", "...  43:\n...  44:    /// <summary>\n  >  45:    /// Creates a validated SaveIdValue instance if possible.\n...  46:    /// </summary>\n...  47:    /// <param name=\"value\">Raw save identifier string.</param>\n...  48:    /// <param name=\"result\">Validated SaveIdValue when successful.</param>\n...  49:    /// <returns>True when the value is valid; otherwise false.</returns>\n...  50:    public static bool TryCreate(string value, out SaveIdValue? result)", "...  46:    /// </summary>\n...  47:    /// <param name=\"value\">Raw save identifier string.</param>\n  >  48:    /// <param name=\"result\">Validated SaveIdValue when successful.</param>\n...  49:    /// <returns>True when the value is valid; otherwise false.</returns>\n...  50:    public static bool TryCreate(string value, out SaveIdValue? result)\n...  51:    {\n...  52:        result = null;\n...  53:", "...  48:    /// <param name=\"result\">Validated SaveIdValue when successful.</param>\n...  49:    /// <returns>True when the value is valid; otherwise false.</returns>\n  >  50:    public static bool TryCreate(string value, out SaveIdValue? result)\n...  51:    {\n...  52:        result = null;\n...  53:\n...  54:        if (string.IsNullOrWhiteSpace(value))\n...  55:            return false;", "...  58:            return false;\n...  59:\n  >  60:        result = new SaveIdValue(value);\n...  61:        return true;\n...  62:    }\n...  63:\n...  64:    /// <summary>\n...  65:    /// Implicit conversion to string for convenience.", "...  65:    /// Implicit conversion to string for convenience.\n...  66:    /// </summary>\n  >  67:    public static implicit operator string(SaveIdValue value) => value.Value;\n...  68:\n...  69:    /// <inheritdoc />\n...  70:    public override string ToString() => Value;\n...  71:}\n...  72:"], "Game.Core\\Engine\\GameTurnSystem.cs": ["...  37:    {\n...  38:        // Validate SaveId using whitelist pattern [a-zA-Z0-9_-]{1,64}\n  >  39:        if (!SaveIdValue.TryCreate(saveId, out var validatedSaveId))\n...  40:        {\n...  41:            throw new ArgumentException(\n...  42:                $\"Invalid SaveId '{saveId}'. Must match [a-zA-Z0-9_-]{{1,64}}\",\n...  43:                nameof(saveId));\n...  44:        }"], "Game.Core\\State\\GameStateManager.cs": ["...  58:\n...  59:        // Avoid collisions when multiple saves occur within the same millisecond (CI can be very fast).\n  >  60:        // Keep ID within 64 chars to remain compatible with SaveIdValue constraints.\n...  61:        var nonce = Guid.NewGuid().ToString(\"N\")[..8];\n...  62:        var saveId = $\"{_options.StorageKey}-{DateTimeOffset.UtcNow.ToUnixTimeMilliseconds()}-{nonce}\";\n...  63:        var checksum = CalculateChecksum(_currentState);\n...  64:        var now = DateTime.UtcNow;\n...  65:"], "Game.Core.Tests\\Domain\\EventEngineTests.cs": ["... 124:            Week: 1,\n... 125:            Phase: GameTurnPhase.Resolution,\n  > 126:            SaveId: new SaveIdValue(\"save-1\"),\n... 127:            CurrentTime: DateTimeOffset.UtcNow\n... 128:        );\n... 129:\n... 130:        // Act\n... 131:        var next = await engine.ExecuteResolutionPhaseAsync(state);", "... 144:            Week: 1,\n... 145:            Phase: GameTurnPhase.Player,\n  > 146:            SaveId: new SaveIdValue(\"save-1\"),\n... 147:            CurrentTime: DateTimeOffset.UtcNow\n... 148:        );\n... 149:\n... 150:        // Act\n... 151:        var next = await engine.ExecutePlayerPhaseAsync(state);", "... 164:            Week: 1,\n... 165:            Phase: GameTurnPhase.AiSimulation,\n  > 166:            SaveId: new SaveIdValue(\"save-1\"),\n... 167:            CurrentTime: DateTimeOffset.UtcNow\n... 168:        );\n... 169:\n... 170:        // Act\n... 171:        var next = await engine.ExecuteAiPhaseAsync(state);", "... 184:            Week: 1,\n... 185:            Phase: GameTurnPhase.Resolution,\n  > 186:            SaveId: new SaveIdValue(\"save-1\"),\n... 187:            CurrentTime: DateTimeOffset.UtcNow\n... 188:        );\n... 189:\n... 190:        // Act\n... 191:        var next = await engine.ExecuteResolutionPhaseAsync(state);", "... 206:            Week: 1,\n... 207:            Phase: GameTurnPhase.Player,\n  > 208:            SaveId: new SaveIdValue(\"save-1\"),\n... 209:            CurrentTime: DateTimeOffset?3407 chars truncated?urrentTime: DateTimeOffset.UtcNow\n... 138:        );\n... 139:\n... 140:        // Act\n... 141:        var next = await system.Advance(state);", "... 154:            Week: 1,\n... 155:            Phase: GameTurnPhase.AiSimulation,\n  > 156:            SaveId: new SaveIdValue(\"save-1\"),\n... 157:            CurrentTime: DateTimeOffset.UtcNow\n... 158:        );\n... 159:\n... 160:        // Act\n... 161:        var next = await system.Advance(state);", "... 207:            Week: 1,\n... 208:            Phase: GameTurnPhase.Resolution,\n  > 209:            SaveId: new SaveIdValue(\"save-1\"),\n... 210:            CurrentTime: DateTimeOffset.UtcNow\n... 211:        );\n... 212:\n... 213:        // Act & Assert\n... 214:        var exception = await Assert.ThrowsAsync<InvalidOperationException>(", "... 231:            Week: 1,\n... 232:            Phase: GameTurnPhase.Player,\n  > 233:            SaveId: new SaveIdValue(\"save-1\"),\n... 234:            CurrentTime: DateTimeOffset.UtcNow\n... 235:        );\n... 236:\n... 237:        // Act & Assert\n... 238:        var exception = await Assert.ThrowsAsync<InvalidOperationException>(", "... 255:            Week: 1,\n... 256:            Phase: GameTurnPhase.AiSimulation,\n  > 257:            SaveId: new SaveIdValue(\"save-1\"),\n... 258:            CurrentTime: DateTimeOffset.UtcNow\n... 259:        );\n... 260:\n... 261:        // Act & Assert\n... 262:        var exception = await Assert.ThrowsAsync<InvalidOperationException>(", "... 278:            Week: 1,\n... 279:            Phase: GameTurnPhase.Resolution,\n  > 280:            SaveId: new SaveIdValue(\"save-1\"),\n... 281:            CurrentTime: DateTimeOffset.UtcNow\n... 282:        );\n... 283:\n... 284:        // Act\n... 285:        var next = await system.Advance(state);", "... 301:            Week: 1,\n... 302:            Phase: GameTurnPhase.Resolution,\n  > 303:            SaveId: new SaveIdValue(\"save-1\"),\n... 304:            CurrentTime: DateTimeOffset.UtcNow\n... 305:        );\n... 306:\n... 307:        // Act\n... 308:        var next = await system.Advance(state);", "... 329:            Week: 1,\n... 330:            Phase: GameTurnPhase.AiSimulation,\n  > 331:            SaveId: new SaveIdValue(\"save-1\"),\n... 332:            CurrentTime: DateTimeOffset.UtcNow\n... 333:        );\n... 334:\n... 335:        // Act\n... 336:        var next = await system.Advance(state);", "... 387:\n... 388:    // =====================================================================\n  > 389:    // SaveIdValue Validation Tests (NG-0040: F001 Security Finding)\n... 390:    // ADR-0019: Godot Security Baseline - Input Validation with Whitelists\n... 391:    // =====================================================================\n... 392:\n... 393:    [Theory]\n... 394:    [InlineData(\"\")]  // Empty string", "... 421:        // Assert\n... 422:        state.SaveId.Should().NotBeNull();\n  > 423:        state.SaveId.ToString().Should().Be(validSaveId);  // SaveIdValue should have meaningful ToString()\n... 424:    }\n... 425:\n... 426:    [Theory]\n... 427:    [InlineData(\"01234567890123456789012345678901234567890123456789012345678901234\")]  // 65 chars - too long\n... 428:    [InlineData(\"this-is-a-very-long-save-id-that-exceeds-the-maximum-allowed-length-of-64-characters\")]  // Way too long", "... 485:    {\n... 486:        // Arrange & Act - RED: This will fail because GameTurnState.SaveId is currently string\n  > 487:        // We want to verify that SaveId is of type SaveIdValue, not string\n... 488:        var stateType = typeof(GameTurnState);\n... 489:        var saveIdProperty = stateType.GetProperty(\"SaveId\");\n... 490:\n... 491:        // Assert\n... 492:        saveIdProperty.Should().NotBeNull();", "... 491:        // Assert\n... 492:        saveIdProperty.Should().NotBeNull();\n  > 493:        saveIdProperty!.PropertyType.Should().Be(typeof(SaveIdValue),\n... 494:            \"SaveId should use SaveIdValue type for type-safe validation (ADR-0019)\");\n... 495:    }\n... 496:}", "... 492:        saveIdProperty.Should().NotBeNull();\n... 493:        saveIdProperty!.PropertyType.Should().Be(typeof(SaveIdValue),\n  > 494:            \"SaveId should use SaveIdValue type for type-safe validation (ADR-0019)\");\n... 495:    }\n... 496:}"], "Game.Core.Tests\\Domain\\SaveIdValueTests.cs": ["...  15:    public void Constructor_Accepts_Valid_Ids(string value)\n...  16:    {\n  >  17:        var id = new SaveIdValue(value);\n...  18:\n...  19:        id.Value.Should().Be(value);\n...  20:        id.ToString().Should().Be(value);\n...  21:    }\n...  22:", "...  29:    public void Constructor_rejects_invalid_ids(string value)\n...  30:    {\n  >  31:        Action act = () => _ = new SaveIdValue(value);\n...  32:\n...  33:        act.Should().Throw<ArgumentException>();\n...  34:    }\n...  35:\n...  36:    [Fact]", "...  39:        var tooLong = new string('a', 65);\n...  40:\n  >  41:        Action act = () => _ = new SaveIdValue(tooLong);\n...  42:\n...  43:        act.Should().Throw<ArgumentException>();\n...  44:    }\n...  45:\n...  46:    [Fact]", "...  47:    public void TryCreate_Returns_True_For_Valid_Value()\n...  48:    {\n  >  49:        var ok = SaveIdValue.TryCreate(\"save-1\", out var value);\n...  50:\n...  51:        ok.Should().BeTrue();\n...  52:        value.Should().NotBeNull();\n...  53:        value!.Value.Should().Be(\"save-1\");\n...  54:    }", "...  57:    public void TryCreate_Returns_False_For_Invalid_Value()\n...  58:    {\n  >  59:        var ok = SaveIdValue.TryCreate(\"invalid/value\", out var value);\n...  60:\n...  61:        ok.Should().BeFalse();\n...  62:        value.Should().BeNull();\n...  63:    }\n...  64:}"]}
