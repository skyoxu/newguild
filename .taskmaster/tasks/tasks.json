{
  "master": {
    "tasks": [
      {
        "id": "1",
        "title": "整理 newguild 首个垂直切片 PRD 与 Overlay 映射",
        "description": "基于现有 ADR 与 Phase 文档，为 newguild 定义首个可玩的垂直切片（例如基础公会管理循环），并将 Story 对齐到 PRD-<PRODUCT> / overlays/08 中的功能纵切文档。产出：一份最小 PRD 片段、对应 overlays 目录与 Test-Refs 协议。",
        "status": "done",
        "priority": "high",
        "dependencies": [],
        "details": "Story: PRD-NEWGUILD-VS-0001\nADR Refs: ADR-0018; ADR-0004; ADR-0005; ADR-0023; ADR-0011\nChapters: CH01; CH04; CH05; CH06; CH07; CH10\nOverlays: docs/architecture/overlays/PRD-Guild-Manager/08/_index.md; docs/architecture/overlays/PRD-Guild-Manager/08/08-功能纵切-公会管理器.md; docs/architecture/overlays/PRD-Guild-Manager/08/ACCEPTANCE_CHECKLIST.md\nAcceptance: 存在一份针对 newguild 的最小 PRD 片段（含输入/输出/状态/存储与非功能约束），并显式引用 ADR-0018/0004/0005/0023/0011。; 在 overlays/PRD-*/08 下新增或调整功能纵切文档，严格遵守 08 章只引用 01/02/03 口径的规则（不复制阈值）。; 每个 Story 至少关联一条 Test-Ref（xUnit 或 GdUnit4），并在文档脚注中列出。\nTest Strategy: 文档审阅：由架构负责人确认 PRD 与 ADR/Phase 一致性。; 链接校验：任务/回链校验脚本通过（task-links-validate）。\nLabels: prd; vertical-slice; docs; architecture\nOwner: architecture\nLayer: docs",
        "testStrategy": "文档审阅：由架构负责人确认 PRD 与 ADR/Phase 一致性。\n链接校验：任务/回链校验脚本通过（task-links-validate）。",
        "updatedAt": "2025-11-30T17:00:56.080Z",
        "subtasks": [],
        "adrRefs": [
          "ADR-0018",
          "ADR-0004",
          "ADR-0005",
          "ADR-0023",
          "ADR-0011"
        ]
      },
      {
        "id": "2",
        "title": "公会管理器首个垂直切片的三层架构与核心类型落地",
        "description": "依据 PRD-Guild-Manager 与 08-功能纵切-公会管理器.md，在 Game.Core / Game.Godot / Tests.Godot 三层落地首个可玩的公会管理垂直切片：实现基础 Guild/GuildMember/Raid/Event 域模型与服务，提供对应的 Godot 场景与 UI Glue，并为该循环建立最小 xUnit 与 GdUnit4 测试集。",
        "status": "done",
        "priority": "high",
        "dependencies": [
          "1"
        ],
        "details": "Story: PRD-GUILD-MANAGER-VS-CORE-LOOP\nADR Refs: ADR-0018; ADR-0004; ADR-0006; ADR-0007; ADR-0005; ADR-0020\nChapters: CH01; CH04; CH05; CH06; CH07\nOverlays: docs/architecture/overlays/PRD-Guild-Manager/08/_index.md; docs/architecture/overlays/PRD-Guild-Manager/08/08-功能纵切-公会管理器.md; docs/architecture/overlays/PRD-Guild-Manager/08/ACCEPTANCE_CHECKLIST.md\nTest Refs: Game.Core.Tests/Domain/GuildCoreTests.cs; Game.Core.Tests/Domain/EventEngineTests.cs; Tests.Godot/tests/Scenes/test_guild_main_scene.gd; Tests.Godot/tests/Integration/test_guild_workflow.gd\nAcceptance: Game.Core 中存在 Guild、GuildMember、Raid、Event 等核心域模型与服务，且不依赖 Godot API。; Game.Godot 中存在与 08-功能纵切-公会管理器.md 一致的主场景与公会管理 UI 节点结构，并通过 Adapters 调用 Game.Core 服务。; Tests.Godot 中存在至少一条完整的垂直切片 GdUnit4 用例：启动主场景 → 进入公会管理界面 → 执行一次最小管理操作（如创建公会或查看成员）→ 正常退出。; Game.Core.Tests 中针对 Guild 与事件引擎的 xUnit 测试存在且可运行，覆盖基础行为与错误路径。; 上述代码与测试在 Windows CI（ci-windows.yml）中均能通过基本构建与测试步骤。; 完成 T2 最小 Guild 领域事件契约集合：core.guild.created、core.guild.member.joined、core.guild.member.left 已分别在 Game.Core/Contracts/Guild/GuildCreated.cs、Game.Core/Contracts/Guild/GuildMemberJoined.cs、Game.Core/Contracts/Guild/GuildMemberLeft.cs 定义，并有至少一个 xUnit 测试类验证 EventType 常量与关键字段。\nTest Strategy: 单元测试：扩展 Game.Core.Tests 覆盖 Guild/GuildMember/Raid/Event 等核心类型的构造与业务规则。; 场景测试：在 Tests.Godot 中编写主场景与公会管理 UI 的 GdUnit4 用例，验证节点结构与关键 Signals。; 集成验证：通过 dev_cli.py run-ci-basic 在本地与 CI 中执行，确认新垂直切片不会破坏现有 CI 流程。\nLabels: core; guild; vertical-slice; architecture\nOwner: architecture\nLayer: core",
        "testStrategy": "单元测试：扩展 Game.Core.Tests 覆盖 Guild/GuildMember/Raid/Event 等核心类型的构造与业务规则。\n场景测试：在 Tests.Godot 中编写主场景与公会管理 UI 的 GdUnit4 用例，验证节点结构与关键 Signals。\n集成验证：通过 dev_cli.py run-ci-basic 在本地与 CI 中执行，确认新垂直切片不会破坏现有 CI 流程。",
        "subtasks": [],
        "updatedAt": "2025-12-01T07:06:50.934Z",
        "adrRefs": [
          "ADR-0018",
          "ADR-0004",
          "ADR-0006",
          "ADR-0007",
          "ADR-0005",
          "ADR-0024",
          "ADR-0020"
        ]
      },
      {
        "id": "3",
        "title": "实现公会管理器事件引擎核心（EventEngine Core）",
        "description": "基于 PRD-Guild-Manager 核心循环（Resolution/Player/AI Simulation）与 Phase-9/Phase-6 设计，在 Game.Core 中实现 EventEngine 核心：负责回合/周循环驱动、事件条件评估、事件执行与冲突解决，作为公会管理垂直切片的事件中枢。",
        "status": "done",
        "priority": "high",
        "dependencies": [
          "2"
        ],
        "details": "Story: PRD-GUILD-MANAGER-CORE-EVENT-ENGINE\nADR Refs: ADR-0018; ADR-0004; ADR-0006; ADR-0007; ADR-0005; ADR-0020\nChapters: CH01; CH04; CH05; CH06; CH07\nOverlays: docs/architecture/overlays/PRD-Guild-Manager/08/08-功能纵切-公会管理器.md; docs/architecture/overlays/PRD-Guild-Manager/08/ACCEPTANCE_CHECKLIST.md\nTest Refs: Game.Core.Tests/Domain/EventEngineTests.cs\nAcceptance: Game.Core 中存在 EventEngine 类（或等价聚合根），负责驱动回合/周循环并对外暴露明确的 API（如 ExecuteResolutionPhase/ExecutePlayerPhase/ExecuteAiPhase）。; 事件引擎能够接受一组领域事件定义（来自 Contracts 或 Domain 类型），根据当前游戏状态评估触发条件，并执行对应效果。; 事件冲突解决规则在 EventEngine 中有清晰实现（如优先级、排他性、合并策略），并在 xUnit 测试中覆盖。; Game.Core.Tests/Domain/EventEngineTests.cs 中存在针对回合循环、条件评估、事件执行、冲突解决的单元测试，全部通过。; EventEngine 不直接依赖 Godot API；与 Godot 的集成通过适配层/Signals 完成（见 NG-0020/NG-0014）。; EventEngine 至少支持上述三类 Guild 领域事件的基本调度：在 Resolution/Player/AI Simulation 周期内能够消费和发布 GuildCreated、GuildMemberJoined、GuildMemberLeft 等事件，对应的行为由 Game.Core.Tests/Domain/EventEngineTests.cs 及相关用例覆盖。\nTest Strategy: 按 PRD 中定义的核心循环（Resolution/Player/AI Simulation）为 EventEngine 设计一组最小测试场景，用 xUnit 验证每个阶段的状态变更是否符合预期。; 为常见事件类型（如成员加入、资源变化、活动结算）设计条件/效果组合，在测试中模拟不同初始状态并验证 EventEngine 输出。; 为冲突场景（多个事件作用于同一实体或互斥条件）编写专门测试，确认 EventEngine 能按预期顺序/规则处理。\nLabels: core; event-engine; guild; simulation\nOwner: architecture\nLayer: core",
        "testStrategy": "按 PRD 中定义的核心循环（Resolution/Player/AI Simulation）为 EventEngine 设计一组最小测试场景，用 xUnit 验证每个阶段的状态变更是否符合预期。\n为常见事件类型（如成员加入、资源变化、活动结算）设计条件/效果组合，在测试中模拟不同初始状态并验证 EventEngine 输出。\n为冲突场景（多个事件作用于同一实体或互斥条件）编写专门测试，确认 EventEngine 能按预期顺序/规则处理。",
        "subtasks": [],
        "updatedAt": "2025-12-02T07:03:53.577Z",
        "adrRefs": [
          "ADR-0018",
          "ADR-0004",
          "ADR-0006",
          "ADR-0007",
          "ADR-0005",
          "ADR-0024",
          "ADR-0020"
        ]
      },
      {
        "id": "4",
        "title": "实现公会管理器核心回合循环与时间推进（Game Loop）",
        "description": "根据 PRD-Guild-Manager 3.0 核心游戏循环设计，在 Game.Core 中实现公会管理器的回合/周循环与时间推进逻辑，并在 Godot 场景中通过 UI 反馈当前周次/阶段/时间进度，支撑首个垂直切片的完整“Resolution→Player→AI Simulation”回合体验。",
        "status": "done",
        "priority": "high",
        "dependencies": [
          "2",
          "3"
        ],
        "details": "Story: PRD-GUILD-MANAGER-CORE-GAME-LOOP\nADR Refs: ADR-0018; ADR-0004; ADR-0006; ADR-0020\nChapters: CH01; CH04; CH05; CH06; CH07\nOverlays: docs/architecture/overlays/PRD-Guild-Manager/08/08-功能纵切-公会管理器.md; docs/architecture/overlays/PRD-Guild-Manager/08/ACCEPTANCE_CHECKLIST.md\nTest Refs: Game.Core.Tests/Domain/GameLoopTests.cs; Tests.Godot/tests/Scenes/test_guild_main_scene.gd; Game.Core.Tests/Domain/GameTurnSystemTests.cs; Tests.Godot/tests/Scenes/test_main_scene_smoke.gd; Tests.Godot/tests/Scenes/Guild/T2PlayableSceneTests.gd\nAcceptance: Game.Core 中存在表示游戏周次/阶段/时间的核心类型与服务（例如 GameTurnSystem 或等价接口），并实现 PRD 中定义的三阶段回合循环。; 游戏时间推进逻辑能够驱动 EventEngine 与 AICoordinator，在至少一个简单场景中完成从 Resolution → Player → AI Simulation 的完整一周循环。; Godot 主场景 UI 能够显示当前周次/阶段/时间状态，并在回合推进时实时更新。; Game.Core.Tests 中存在 GameLoopTests（或等价），覆盖时间推进、阶段切换以及回合边界条件；Tests.Godot 中有用例验证 UI 与 Core 状态同步。; Game.Core 与 Godot 场景的组合至少能够完成 PRD 3.0.3 T2 可玩性场景流中描述的一次完整循环：从启动主场景进入首周公会管理界面，执行一次完整的 Resolution→Player→AI Simulation 一周循环，并安全返回主菜单或结束会话；对应的 xUnit 和 GdUnit4/headless 用例挂接在 NG-0021 的 test_refs 中并在 CI 中保持绿灯。; GM-0103 所需的 T2 流程最小测试入口已经落在 Game.Core.Tests/Domain/GameLoopTests.cs 与 Tests.Godot/tests/Scenes/Guild/T2PlayableSceneTests.gd；后续扩展测试应在此基础上补充，而不是新建平行入口文件。\nTest Strategy: 在 xUnit 中为 GameLoop 设计一组“单周循环”用例，验证每个阶段的调用顺序与状态变化是否符合 PRD 描述。; 在 GdUnit4 中为主场景编写测试，通过模拟回合推进（调用 public 方法或连接信号）检查 UI 显示是否与 Core 状态一致。; 结合 GM-0101/GM-0102，用一个最小的“公会一周生活”场景验证事件触发、AI 行为与 UI 反馈闭环。\nLabels: core; game-loop; time; guild\nOwner: architecture\nLayer: core",
        "testStrategy": "在 xUnit 中为 GameLoop 设计一组“单周循环”用例，验证每个阶段的调用顺序与状态变化是否符合 PRD 描述。\n在 GdUnit4 中为主场景编写测试，通过模拟回合推进（调用 public 方法或连接信号）检查 UI 显示是否与 Core 状态一致。\n结合 GM-0101/GM-0102，用一个最小的“公会一周生活”场景验证事件触发、AI 行为与 UI 反馈闭环。",
        "subtasks": [],
        "updatedAt": "2025-12-02T09:24:59.747Z",
        "adrRefs": [
          "ADR-0018",
          "ADR-0004",
          "ADR-0006",
          "ADR-0024",
          "ADR-0020"
        ]
      },
      {
        "id": "5",
        "title": "Python 版 headless smoke 封装与 strict 模式开关",
        "description": "根据 Phase-12-Headless-Smoke-Backlog.md B1/B2，在当前 Godot + C# 模板中实现 Python 版 headless smoke 封装脚本（替代/补充 PowerShell 版本），并增加 strict 模式：严格依赖 [TEMPLATE_SMOKE_READY]/[DB] opened marker 决定通过与否。",
        "status": "done",
        "priority": "high",
        "dependencies": [
          "1"
        ],
        "details": "Story: PH12-BACKLOG-B1-B2\nADR Refs: ADR-0005; ADR-0011; ADR-0018; ADR-0020\nChapters: CH01; CH06; CH07; CH10\nTest Refs: logs/ci/<date>/smoke/headless.log; logs/ci/<date>/smoke/selfcheck-summary.json\nAcceptance: 新增 scripts/python/smoke_headless.py（或等价脚本），支持 --godot-bin/--scene/--timeout-sec/--project-path 参数，并在 Windows 上可直接运行。; 非 strict 模式下，脚本行为与现有 PowerShell 版本等价，输出写入 logs/ci/<date>/smoke/**，并保留宽松判定。; strict 模式下，仅当日志包含 [TEMPLATE_SMOKE_READY] 或 [DB] opened 时返回 0，否则返回非零并在日志中标记为 strict-failed。; ci-windows.yml 或 windows-quality-gate.yml 至少提供一条注释示例，展示如何在受保护分支启用 strict 模式。\nTest Strategy: 本地运行：在 Windows 环境下通过 dev_cli.py 调用 Python 版 smoke，验证日志与退出码。; CI 演练：在非受保护分支上打开 strict 模式，观察 smoke 失败时的门禁行为与日志输出。\nLabels: ci; smoke; godot; python; headless\nOwner: architecture\nLayer: ci",
        "testStrategy": "本地运行：在 Windows 环境下通过 dev_cli.py 调用 Python 版 smoke，验证日志与退出码。\nCI 演练：在非受保护分支上打开 strict 模式，观察 smoke 失败时的门禁行为与日志输出。",
        "subtasks": [],
        "updatedAt": "2025-12-02T17:44:19.673Z",
        "adrRefs": [
          "ADR-0005",
          "ADR-0011",
          "ADR-0018",
          "ADR-0024",
          "ADR-0020"
        ]
      },
      {
        "id": "6",
        "title": "首个垂直切片的最小 xUnit/GdUnit4/Smoke 流程打通",
        "description": "在 newguild 模板下，为 PRD-Guild-Manager 的首个公会管理垂直切片建立最小可用的测试与 CI 流程：xUnit 覆盖核心域逻辑，GdUnit4 覆盖主场景与基本交互，headless smoke 验证游戏能从命令行启动到主场景并正常退出，所有步骤在 dev_cli.py 与 Windows CI 工作流中可自动执行。",
        "status": "done",
        "priority": "high",
        "dependencies": [
          "1",
          "5",
          "2"
        ],
        "details": "Story: PRD-GUILD-MANAGER-VS-TEST-CI\nADR Refs: ADR-0005; ADR-0011; ADR-0018; ADR-0020\nChapters: CH01; CH06; CH07; CH10\nOverlays: docs/architecture/overlays/PRD-Guild-Manager/08/08-功能纵切-公会管理器.md; docs/architecture/overlays/PRD-Guild-Manager/08/ACCEPTANCE_CHECKLIST.md\nTest Refs: Game.Core.Tests/Domain/GuildCoreTests.cs; Game.Core.Tests/Domain/GameTurnSystemTests.cs; Tests.Godot/tests/Scenes/test_guild_main_scene.gd; Tests.Godot/tests/Scenes/test_main_scene_smoke.gd; logs/ci/<date>/ci-pipeline-summary.json; logs/e2e/<date>/smoke/selfcheck-summary.json; Game.Core.Tests/Domain/GameLoopTests.cs; Tests.Godot/tests/Scenes/Guild/T2PlayableSceneTests.gd\nAcceptance: dev_cli.py run-ci-basic 在本地 Windows 环境下能成功运行，并至少执行一次 dotnet test 与一次 headless smoke。; Windows CI 工作流（ci-windows.yml 或 windows-quality-gate.yml）中包含对 Game.Core.Tests 与 Tests.Godot 的执行步骤，且在首个垂直切片落地后仍然全部通过。; headless smoke 用例能够在不依赖交互的情况下启动游戏主场景，并输出 [TEMPLATE_SMOKE_READY] 或 [DB] opened 标记。; 至少存在一条覆盖 PRD 3.0.3 T2 可玩性场景流的端到端测试路径：Game.Core.Tests/Domain/GameTurnSystemTests.cs（或等价用例）验证三阶段一周循环的状态推进，Tests.Godot/tests/Scenes/test_main_scene_smoke.gd（或等价用例）验证从启动主场景进入首周公会管理界面并完成一次“推进一周”的 UI 流程。; 失败的测试或 smoke 能在 logs/ci 与 logs/e2e 目录下生成可用于排查的 JSON/文本日志，与 AGENTS.md 中的日志规范一致。; Game.Core.Tests/Domain/GameLoopTests.cs 与 Tests.Godot/tests/Scenes/Guild/T2PlayableSceneTests.gd 已作为 PRD 3.0.3 T2 可玩性场景流的最小测试入口，分别覆盖 Core 回合状态与场景可玩闭环，并挂接在 NG-0021 与 GM-0103 的 Test-Refs 中。\nTest Strategy: 本地：使用 dev_cli.py run-ci-basic 与 run-smoke-strict（如已实现）验证测试和 smoke 流程。; CI：在测试分支上触发 ci-windows 与 windows-quality-gate 工作流，确认所有步骤通过且生成预期的 logs/** 工件。\nLabels: ci; testing; smoke; xunit; gdunit\nOwner: architecture\nLayer: ci",
        "testStrategy": "本地：使用 dev_cli.py run-ci-basic 与 run-smoke-strict（如已实现）验证测试和 smoke 流程。\nCI：在测试分支上触发 ci-windows 与 windows-quality-gate 工作流，确认所有步骤通过且生成预期的 logs/** 工件。",
        "subtasks": [],
        "updatedAt": "2025-12-04T14:19:40.651Z",
        "adrRefs": [
          "ADR-0005",
          "ADR-0011",
          "ADR-0018",
          "ADR-0024",
          "ADR-0020"
        ]
      },
      {
        "id": "7",
        "title": "扩展 quality_gates.py 覆盖率阈值与 GdUnit4 集成",
        "description": "承接 Phase-13-Quality-Gates-Script.md 与 Backlog：将 xUnit 覆盖率门禁提升到蓝图标准（行≥90%、分支≥85%，可由环境变量覆盖），并把关键 GdUnit4 集合（Adapters+Security 小集）通过 quality_gates.py 聚合输出到统一 summary，以便在 CI 中统一判定。",
        "status": "pending",
        "priority": "high",
        "dependencies": [
          "5"
        ],
        "details": "Story: PH13-BACKLOG-B1-B2-B5\nADR Refs: ADR-0005; ADR-0015; ADR-0018; ADR-0024\nChapters: CH01; CH06; CH07; CH09\nTest Refs: logs/ci/<date>/unit/coverage.json; logs/e2e/<date>/gdunit-hard/run-summary.json; logs/ci/<date>/quality-gates-summary.json\nAcceptance: scripts/python/run_dotnet.py 读取覆盖率结果并在 summary.json 中写入 lines/branches 与阈值配置（默认 90/85，可由环境变量覆盖）。; 当覆盖率低于阈值时，quality_gates.py 在 summary 中标记为 failed，并可配置为软/硬门禁（至少支持硬门禁）。; quality_gates.py 能调用 run_gdunit.py 或等价封装，执行 Adapters+Security 硬门禁集合，并在 quality-gates-summary.json 中汇总结果。; Windows Quality Gate 工作流调用 quality_gates.py all 时，能在 Step Summary 中清晰展示 dotnet 覆盖率与 GdUnit4 集合结果。\nTest Strategy: 本地模拟：手工降低测试覆盖率，验证 quality_gates.py 将其标记为 failed，并按配置返回非零 exit code。; CI 验证：在 PR 上运行 windows-quality-gate 工作流，观察 coverage 与 GdUnit4 结果是否在 Step Summary 与 artifacts 中正确展示。\nLabels: ci; quality-gates; coverage; gdunit\nOwner: architecture\nLayer: ci",
        "testStrategy": "本地模拟：手工降低测试覆盖率，验证 quality_gates.py 将其标记为 failed，并按配置返回非零 exit code。\nCI 验证：在 PR 上运行 windows-quality-gate 工作流，观察 coverage 与 GdUnit4 结果是否在 Step Summary 与 artifacts 中正确展示。",
        "subtasks": [],
        "updatedAt": "2025-12-18T12:40:00.000Z",
        "adrRefs": [
          "ADR-0005",
          "ADR-0015",
          "ADR-0018",
          "ADR-0024"
        ]
      },
      {
        "id": "8",
        "title": "Godot 安全适配层增强：外链白名单、文件访问与 OS.execute 守卫",
        "description": "按照 Phase-14-Godot-Security-Baseline.md 与 Backlog，对当前 Godot+C# 模板补齐安全适配层：统一外链白名单配置（ALLOWED_EXTERNAL_HOSTS）、文件访问适配（仅 res:// 与 user://，拒绝 .. 和绝对路径）、显式封装 OS.execute，并为安全审计 JSONL 增加格式校验与最小测试集。",
        "status": "done",
        "priority": "high",
        "dependencies": [
          "1"
        ],
        "blockers": [
          "RESOLVED: A1 - SecurityUrlAdapter 已迁移至 Tests.Godot/Game.Godot/Adapters/Security/（符合 ADR-0007）",
          "RESOLVED: A2 - 已定义 ISecurityUrlValidator 接口在 Game.Core/Interfaces/（DIP 合规）",
          "RESOLVED: C3 - SSRF 防护已实现：null/空白名单拒绝所有 URL（CWE-918）",
          "PENDING: D1-D3 - 事件命名需统一为 ADR-0004 格式（core.security.url.rejected）",
          "PENDING: B3 - SafeResourcePath 需补充 Windows 反斜杠路径遍历检测",
          "PENDING: C2 - SecurityProcessAdapter 审计日志需脱敏处理"
        ],
        "details": "Story: PH14-BACKLOG-B1-B2-B3-B4\nADR Refs: ADR-0019 (Security Baseline); ADR-0007 (Ports and Adapters); ADR-0004 (Event Bus); ADR-0011 (Windows-only)\nChapters: CH02 (Security); CH05 (Data Models); CH07 (Dev Build); CH10 (i18n Ops)\nOverlay: docs/architecture/overlays/PRD-Guild-Manager/08/08-功能纵切-安全适配.md\nTest Refs: Tests.Godot/tests/Security/Hard/test_url_security_adapter.gd (11 tests, 100% pass); logs/ci/2025-12-10/security-audit.jsonl\nAcceptance: 外链访问统一通过 SecurityUrlAdapter 完成，强制 HTTPS + ALLOWED_EXTERNAL_HOSTS 白名单，禁止 file://、javascript:、data:、blob: 等高危 scheme（ADR-0019）。; 文件访问统一通过 SecurityFileAdapter 封装，仅允许 res:// 读取与 user:// 读写，拒绝绝对路径与 .. 越权访问。; OS.execute 通过 SecurityProcessAdapter 封装，默认运行时禁用，开发/CI 模式白名单执行。; 安全审计 JSONL 格式符合 {ts, action, reason, target, caller} 五字段要求。; GdUnit4 Hard 测试覆盖 allow/deny/invalid/SSRF 四态场景，100% 通过率。; 架构验收：通过 /acceptance-check 无 Critical Blockers。\nTest Strategy: GdUnit4 安全用例：Hard 集测试外链、文件、进程三类接口的 allow/deny/invalid 行为。\n脚本校验：scripts/python/validate_audit_logs.py 针对 security-audit.jsonl 做格式与字段校验。\nxUnit 单元测试：Game.Core.Tests/Services/SecurityAdapterTests.cs 作为 SSoT 验证安全契约。\nLabels: security; godot; adapter; filesystem; process\nOwner: architecture\nLayer: adapter",
        "testStrategy": "三层测试策略：\n1. xUnit 单元测试（Game.Core.Tests）- 纯 C# 逻辑，验证安全契约\n2. GdUnit4 集成测试（Tests.Godot/tests/Security/Hard）- Godot 运行时互操作性\n3. Python 脚本验证（scripts/python/validate_audit_logs.py）- 审计日志格式合规",
        "updatedAt": "2025-12-13T10:43:18.951Z",
        "subtasks": [
          {
            "id": 1,
            "title": "Implement External Link Whitelist Configuration",
            "description": "开发 SecurityUrlAdapter 以强制执行外部链接白名单和 HTTPS scheme，禁止高风险 scheme（file://, javascript:, data:, blob:）。",
            "dependencies": [],
            "details": "实现目标：\n- 创建 ISecurityUrlValidator 接口（Game.Core/Interfaces/ISecurityUrlValidator.cs）定义安全契约\n- 实现 SecurityUrlAdapter（Tests.Godot/Game.Godot/Adapters/Security/SecurityUrlAdapter.cs）封装 Godot 适配层\n- 支持 ALLOWED_EXTERNAL_HOSTS 白名单配置（数组或环境变量）\n- SSRF 防护：null/空白名单时拒绝所有外部 URL（CWE-918, CVSS 8.6）\n- 审计日志：拒绝事件写入 security-audit.jsonl（JSONL 格式，五字段）\n\n实现细节：\n1. 接口定义（ISecurityUrlValidator）：\n   - IReadOnlyList<string>? AllowedHosts { get; }\n   - bool IsUrlAllowed(string url)\n   - (bool IsAllowed, string? RejectionReason) ValidateAndAudit(string url, string caller)\n\n2. 适配器实现（SecurityUrlAdapter）：\n   - 继承 RefCounted（Godot 可调用）\n   - 实现接口：显式接口实现 + 公共 GDScript 可访问方法\n   - 验证逻辑：null/空检查 → SSRF 检查 → URI 解析 → scheme 验证 → HTTPS 强制 → 白名单匹配\n   - 审计日志：WriteAuditLog() 写入 {ts, action, reason, target, caller}\n\n3. 工厂模式（SecurityUrlAdapterFactory）：\n   - CreateWithWhitelist(string[] allowedHosts, string? auditLogPath)\n   - CreateWithSsrfProtection(string? auditLogPath)\n   - CreateForTesting(string? auditLogPath)\n   - CreateFromGodotArray(Godot.Collections.Array godotArray, string? auditLogPath)\n\n技术挑战与解决：\n- 问题 1：工厂方法返回接口类型导致 GDScript 无法识别\n  解决：改为返回具体类型 SecurityUrlAdapter\n- 问题 2：ValidateAndAudit 返回元组无法跨语言边界\n  解决：创建 UrlValidationResult 类支持 Get(int index) 方法\n- 问题 3：AllowedHosts 返回 IReadOnlyList<string>? 导致 GDScript 无法访问\n  解决：显式接口实现 + 公共属性返回 global::Godot.Collections.Array\n- 问题 4：命名空间冲突（Game.Godot vs Godot）\n  解决：使用 global::Godot.Collections.Array 绕过命名空间解析\n\n安全保证（ADR-0019）：\n[OK] HTTPS-only 强制执行\n[OK] 白名单域名验证\n[OK] 危险 scheme 阻止（javascript:, file:, data:, blob:）\n[OK] SSRF 防护（null/空白名单拒绝所有 URL）\n[OK] 审计日志记录\n[OK] 白名单配置暴露（AllowedHosts 属性）",
            "status": "done",
            "testStrategy": "测试覆盖（11 tests, 100% pass）：\n1. test_allows_whitelisted_https_url - 白名单 HTTPS 通过\n2. test_rejects_http_scheme - HTTP scheme 拒绝\n3. test_rejects_dangerous_schemes - 危险 scheme 阻止（javascript:, file:, data:, blob:）\n4. test_rejects_non_whitelisted_domain - 非白名单域名拒绝\n5. test_rejects_all_urls_when_whitelist_null - SSRF 防护（null 白名单）\n6. test_rejects_all_urls_when_whitelist_empty - SSRF 防护（空白名单）\n7. test_rejects_invalid_uri_format - 无效 URI 格式处理\n8. test_rejects_null_or_empty_url - null/空 URL 拒绝\n9. test_exposes_allowed_hosts_property - AllowedHosts 属性暴露（GDScript Array.size()）\n10. test_null_whitelist_exposes_null_property - null 白名单暴露 null\n11. test_audit_log_written_on_rejection - 审计日志文件创建\n\nxUnit 补充测试：\n- Game.Core.Tests/Services/SecurityAdapterTests.cs - 纯 C# 安全契约验证\n- 覆盖率：lines ≥90%, branches ≥85%（ADR-0005 质量门禁）",
            "parentId": "8",
            "updatedAt": "2025-12-10T08:00:00.000Z",
            "implementationNotes": "文件清单：\n- Game.Core/Interfaces/ISecurityUrlValidator.cs（接口定义）\n- Tests.Godot/Game.Godot/Adapters/Security/SecurityUrlAdapter.cs（适配器实现）\n- Tests.Godot/Game.Godot/Adapters/Security/SecurityUrlAdapterFactory.cs（工厂类）\n- Tests.Godot/Game.Godot/Adapters/Security/UrlValidationResult.cs（结果类）\n- Tests.Godot/Game.Godot/Adapters/Security/security_url_adapter_factory.gd（GDScript 包装器）\n- Tests.Godot/tests/Security/Hard/test_url_security_adapter.gd（GdUnit4 测试套件）\n\n互操作性模式（Godot C# ↔ GDScript）：\n1. 显式接口实现模式 - 满足 Core 层接口契约 + GDScript 可访问性\n2. 具体类型返回 - 工厂方法返回 SecurityUrlAdapter 而非接口\n3. RefCounted 继承 - 确保 GDScript 可调用\n4. Get() 方法模式 - C# 索引器不导出，需显式方法\n5. global:: 命名空间别名 - 解决命名空间冲突\n6. GDScript API 适配 - Array.size() 替代 Count 属性\n\n审计日志格式（security-audit.jsonl）：\n{\n  \"ts\": \"2025-12-10T08:00:00.000Z\",\n  \"action\": \"security.url.rejected\",\n  \"reason\": \"Non-HTTPS scheme rejected: http\",\n  \"target\": \"http://example.com/api\",\n  \"caller\": \"test_rejects_http_scheme\"\n}"
          },
          {
            "id": 2,
            "title": "Enhance File Access Security",
            "description": "实现 SecurityFileAdapter 限制文件访问到 res:// 和 user:// 路径，拒绝绝对路径和 .. 路径遍历。",
            "dependencies": [
              1
            ],
            "details": "实现目标：\n- 创建 ISecurityFileValidator 接口定义文件访问安全契约\n- 实现 SecurityFileAdapter 封装 FileAccess/DirAccess API\n- 仅允许 res:// 读取、user:// 读写\n- 路径遍历防护：检测并拒绝 '../', '..\\\\', '%2e%2e' 等（CWE-22, CVSS 9.1）\n- 绝对路径拒绝：禁止 'C:\\\\', '/etc/', '/tmp/' 等系统路径\n- 审计日志：拒绝事件写入 security-audit.jsonl\n\n实现细节：\n1. 接口定义（ISecurityFileValidator）：\n   - bool IsPathAllowed(string path, FileAccessMode mode)\n   - (bool IsAllowed, string? RejectionReason) ValidateAndAudit(string path, FileAccessMode mode, string caller)\n   - string NormalizePath(string path)\n\n2. 适配器实现（SecurityFileAdapter）：\n   - 路径规范化：转换为小写、统一路径分隔符\n   - res:// 前缀：只读访问，验证资源存在性\n   - user:// 前缀：读写访问，自动创建目录\n   - 路径遍历检测：多重编码检查（'../', '..\\\\', '%2e%2e', '%2e%2e%2f'）\n   - 绝对路径拒绝：Windows (C:, D:) + Unix (/etc, /tmp, /var)\n   - 扩展名白名单：.txt, .json, .cfg, .dat, .sav（可配置）\n   - 大小限制：单文件 ≤ 10MB（可配置）\n\n3. 工厂模式（SecurityFileAdapterFactory）：\n   - CreateWithDefaults(string? auditLogPath)\n   - CreateWithExtensionWhitelist(string[] allowedExtensions, string? auditLogPath)\n   - CreateForTesting(string? auditLogPath)\n\n技术挑战：\n- Windows 路径大小写不敏感处理\n- 反斜杠与正斜杠混用场景\n- 符号链接检测（Godot FileAccess 不支持）\n- 多重编码路径遍历（URL 编码、双重编码）\n\n安全保证：\n[OK] res:// 只读隔离\n[OK] user:// 读写隔离\n[OK] 路径遍历防护（CWE-22）\n[OK] 绝对路径拒绝\n[OK] 扩展名白名单\n[OK] 文件大小限制",
            "status": "done",
            "testStrategy": "GdUnit4 测试覆盖（预计 15+ tests）：\nALLOW 场景：\n- test_allows_res_read_valid_file\n- test_allows_user_read_write_valid_file\n- test_allows_nested_user_directories\n\nDENY 场景：\n- test_rejects_absolute_path_windows\n- test_rejects_absolute_path_unix\n- test_rejects_path_traversal_dotdot_slash\n- test_rejects_path_traversal_dotdot_backslash\n- test_rejects_path_traversal_url_encoded\n- test_rejects_disallowed_extension\n- test_rejects_file_too_large\n- test_rejects_res_write_attempt\n\nINVALID 场景：\n- test_rejects_null_or_empty_path\n- test_rejects_malformed_path\n\nAUDIT 场景：\n- test_audit_log_written_on_rejection\n- test_audit_log_contains_required_fields",
            "parentId": "8",
            "implementationNotes": "文件清单（待创建）：\n- Game.Core/Interfaces/ISecurityFileValidator.cs\n- Tests.Godot/Game.Godot/Adapters/Security/SecurityFileAdapter.cs\n- Tests.Godot/Game.Godot/Adapters/Security/SecurityFileAdapterFactory.cs\n- Tests.Godot/Game.Godot/Adapters/Security/FileValidationResult.cs\n- Tests.Godot/Game.Godot/Adapters/Security/security_file_adapter_factory.gd\n- Tests.Godot/tests/Security/Hard/test_file_security_adapter.gd\n\nADR-0020 SafeResourcePath 集成：\n- 复用 SafeResourcePath.ContainsPathTraversal() 逻辑\n- 补充 Windows 反斜杠检测（Blocker B3）\n- 统一路径验证入口点",
            "updatedAt": "2025-12-12T17:43:57.642Z"
          },
          {
            "id": 3,
            "title": "Secure OS.execute Functionality",
            "description": "封装 OS.execute 通过 SecurityProcessAdapter 控制执行，默认运行时禁用，开发/CI 模式白名单执行。",
            "dependencies": [
              2
            ],
            "details": "实现目标：\n- 创建 ISecurityProcessValidator 接口定义进程执行安全契约\n- 实现 SecurityProcessAdapter 封装 OS.execute\n- 默认行为：运行时（GD_SECURE_MODE=1）拒绝所有进程执行\n- 开发模式：GD_SECURE_MODE=0 时允许白名单命令\n- CI 模式：SECURITY_TEST_MODE=1 时审计所有调用但不阻止\n- 命令白名单：可执行文件路径 + 参数模式匹配\n- 参数脱敏：审计日志不记录 --password, --token 等敏感参数（Blocker C2）\n- 审计日志：所有执行请求写入 security-audit.jsonl\n\n实现细节：\n1. 接口定义（ISecurityProcessValidator）：\n   - bool IsExecutionAllowed(string command, string[] arguments)\n   - (bool IsAllowed, string? RejectionReason) ValidateAndAudit(string command, string[] arguments, string caller)\n   - string SanitizeArguments(string[] arguments)\n\n2. 适配器实现（SecurityProcessAdapter）：\n   - 模式检测：GD_SECURE_MODE（安全模式）、SECURITY_TEST_MODE（测试模式）\n   - 命令白名单：允许的可执行文件列表（git, dotnet, py, python3 等）\n   - 参数脱敏：检测并替换敏感参数（--password ***, --token ***, --api-key ***）\n   - 路径验证：只允许系统 PATH 或明确配置的可执行文件路径\n   - 超时控制：默认 30s，防止进程挂起\n   - 输出限制：stdout/stderr ≤ 1MB，防止日志炸弹\n\n3. 工厂模式（SecurityProcessAdapterFactory）：\n   - CreateWithDefaults(string? auditLogPath)\n   - CreateWithWhitelist(string[] allowedCommands, string? auditLogPath)\n   - CreateForTesting(string? auditLogPath)\n\n技术挑战：\n- OS.execute 在 Godot 4.5 无异步支持，需主线程阻塞\n- 参数脱敏需识别多种敏感参数格式（--password, -p, /p）\n- Windows vs Unix 命令白名单差异\n- 审计日志避免记录完整命令行（CWE-532, CVSS 7.5）\n\n安全保证：\n[OK] 默认拒绝进程执行（安全模式）\n[OK] 命令白名单验证\n[OK] 参数脱敏保护（CWE-532）\n[OK] 路径验证防止任意执行\n[OK] 超时控制防止挂起\n[OK] 输出限制防止资源耗尽",
            "status": "done",
            "testStrategy": "GdUnit4 测试覆盖（预计 12+ tests）：\nALLOW 场景：\n- test_allows_whitelisted_command_in_dev_mode\n- test_allows_whitelisted_command_with_safe_args\n\nDENY 场景：\n- test_rejects_all_commands_in_secure_mode\n- test_rejects_non_whitelisted_command\n- test_rejects_command_with_dangerous_args\n- test_rejects_absolute_path_command\n- test_rejects_command_timeout_exceeded\n\nSENSITIVE 场景：\n- test_sanitizes_password_argument\n- test_sanitizes_token_argument\n- test_sanitizes_api_key_argument\n- test_audit_log_no_sensitive_data\n\nMODE 场景：\n- test_secure_mode_blocks_all_execution\n- test_test_mode_audits_but_allows_execution",
            "parentId": "8",
            "implementationNotes": "文件清单（待创建）：\n- Game.Core/Interfaces/ISecurityProcessValidator.cs\n- Tests.Godot/Game.Godot/Adapters/Security/SecurityProcessAdapter.cs\n- Tests.Godot/Game.Godot/Adapters/Security/SecurityProcessAdapterFactory.cs\n- Tests.Godot/Game.Godot/Adapters/Security/ProcessValidationResult.cs\n- Tests.Godot/Game.Godot/Adapters/Security/security_process_adapter_factory.gd\n- Tests.Godot/tests/Security/Hard/test_process_security_adapter.gd\n\n环境变量配置：\n- GD_SECURE_MODE=1 - 启用安全模式（默认拒绝所有进程执行）\n- SECURITY_TEST_MODE=1 - 测试模式（审计但不阻止）\n- ALLOWED_COMMANDS=git,dotnet,py - 白名单命令（逗号分隔）\n\nCI 集成：\n- scripts/python/validate_audit_logs.py 检查审计日志无敏感数据泄露\n- scripts/python/run_gdunit.py --suite security 运行安全测试套件",
            "updatedAt": "2025-12-13T05:13:47.686Z"
          },
          {
            "id": 4,
            "title": "Validate Security Audit JSONL Format",
            "description": "开发脚本验证 security-audit.jsonl 格式，确保每行合法 JSON 且包含必需字段 {ts, action, reason, target, caller}。",
            "dependencies": [
              3
            ],
            "details": "实现目标：\n- 创建 scripts/python/validate_audit_logs.py 验证审计日志格式\n- JSONL 格式验证：每行独立 JSON 对象，无尾随逗号\n- 必需字段验证：{ts, action, reason, target, caller} 五字段存在且非空\n- 时间戳验证：ts 字段符合 ISO 8601 格式（YYYY-MM-DDTHH:mm:ss.sssZ）\n- Action 格式验证：action 字段符合 ADR-0004 点分隔命名（domain.entity.verb）\n- 敏感数据检测：扫描 target/reason 字段，确保无明文密码/Token\n- CI 集成：作为质量门禁的一部分在 CI 中运行\n\n实现细节：\n1. 脚本参数：\n   - --log-path <path> - 审计日志路径（支持通配符）\n   - --strict - 严格模式（发现任何错误即失败）\n   - --report <path> - 输出验证报告 JSON\n   - --check-sensitive - 启用敏感数据扫描\n\n2. 验证规则：\n   a) 格式验证：\n      - 每行必须是合法 JSON 对象\n      - 不允许 JSON 数组或嵌套结构\n      - 字段值类型检查（ts: string, action: string 等）\n   \n   b) 字段验证：\n      - ts: ISO 8601 时间戳，范围检查（不能是未来时间）\n      - action: 符合 ADR-0004 命名（security.url.rejected, security.file.rejected 等）\n      - reason: 非空字符串，长度 ≤ 500\n      - target: 非空字符串，长度 ≤ 1000\n      - caller: 非空字符串，标识调用者（函数名、测试名等）\n   \n   c) 敏感数据扫描：\n      - 检测模式：password, token, api-key, secret, credential\n      - 排除：脱敏后的形式（***、[REDACTED]）\n      - 违规：明文出现上述关键词且值非 ***\n\n3. 输出格式：\n   - 控制台：彩色输出（绿色 PASS, 红色 FAIL）\n   - JSON 报告：{valid: bool, errors: [], warnings: [], stats: {}}\n   - 退出码：0（成功）、1（验证失败）、2（文件不存在）\n\n技术挑战：\n- 大文件处理（流式读取，避免内存溢出）\n- 多日志文件聚合验证（logs/ci/**/*.jsonl）\n- Windows 路径处理（反斜杠转义）\n- 时区处理（UTC vs 本地时间）\n\n质量门禁集成：\n- CI 作业 \"security-audit-validation\"\n- 依赖：godot-e2e（生成审计日志）\n- 失败阈值：errors > 0 即阻止合并",
            "status": "done",
            "testStrategy": "Python 单元测试（pytest）：\n- test_valid_jsonl_format - 合法 JSONL 通过\n- test_invalid_json_syntax - JSON 语法错误检测\n- test_missing_required_field - 缺失必需字段检测\n- test_invalid_timestamp_format - 时间戳格式错误检测\n- test_invalid_action_format - Action 命名格式错误检测\n- test_sensitive_data_detection - 敏感数据扫描\n- test_empty_file - 空文件处理\n- test_large_file_streaming - 大文件流式处理\n- test_multiple_files_aggregation - 多文件聚合验证\n\nCI 验证：\n- 运行 py -3 scripts/python/validate_audit_logs.py --log-path logs/ci/**/*.jsonl --strict\n- 验证退出码 0\n- 检查报告 JSON 输出",
            "parentId": "8",
            "implementationNotes": "文件清单（待创建）：\n- scripts/python/validate_audit_logs.py（主验证脚本）\n- scripts/python/tests/test_validate_audit_logs.py（pytest 单元测试）\n- .github/workflows/security-audit-validation.yml（CI 作业配置）\n\n依赖库：\n- Python 3.8+\n- json（标准库）\n- datetime（标准库）\n- pathlib（标准库）\n- pytest（开发依赖）\n\nCI 作业示例（.github/workflows/ci.yml）：\n```yaml\nsecurity-audit-validation:\n  runs-on: windows-latest\n  needs: godot-e2e\n  steps:\n    - uses: actions/checkout@v4\n    - name: Validate Security Audit Logs\n      run: |\n        py -3 scripts/python/validate_audit_logs.py \\\n          --log-path logs/ci/**/*.jsonl \\\n          --strict \\\n          --check-sensitive \\\n          --report logs/ci/audit-validation-report.json\n    - name: Upload Validation Report\n      if: always()\n      uses: actions/upload-artifact@v4\n      with:\n        name: audit-validation-report\n        path: logs/ci/audit-validation-report.json\n```",
            "updatedAt": "2025-12-13T06:12:00.435Z"
          },
          {
            "id": 5,
            "title": "Expand GdUnit4 Hard Test Coverage",
            "description": "扩展 GdUnit4 Hard 测试套件，覆盖外链、文件、进程接口的 allow/deny/invalid/SSRF 四态场景，作为 CI 门禁。",
            "dependencies": [
              4
            ],
            "details": "实现目标：\n- 扩展 Tests.Godot/tests/Security/Hard/ 目录下的安全测试\n- 覆盖三类安全适配器：URL、File、Process\n- 四态场景：allow（白名单通过）、deny（拒绝并审计）、invalid（非法输入）、SSRF（防护验证）\n- 审计日志验证：每个拒绝场景验证审计文件生成\n- 性能验证：单个测试 ≤ 100ms（安全检查不应显著影响性能）\n- CI 集成：作为 godot-e2e 作业的一部分运行\n\n实现细节：\n1. 测试套件结构：\n   tests/Security/Hard/\n   ├── test_url_security_adapter.gd（已完成，11 tests）\n   ├── test_file_security_adapter.gd（待创建，预计 15 tests）\n   ├── test_process_security_adapter.gd（待创建，预计 12 tests）\n   ├── test_security_integration.gd（待创建，集成测试）\n   └── test_audit_log_compliance.gd（待创建，审计日志合规）\n\n2. 测试模式：\n   a) URL 适配器（test_url_security_adapter.gd）：\n      [OK] 已完成 11 tests，100% 通过\n      [OK] 覆盖 allow/deny/invalid/SSRF 四态\n      [OK] 审计日志验证\n   \n   b) File 适配器（test_file_security_adapter.gd）：\n      - ALLOW: res:// 读取、user:// 读写、嵌套目录\n      - DENY: 绝对路径、路径遍历、禁止扩展名、文件过大、res:// 写入\n      - INVALID: null/空路径、格式错误路径\n      - AUDIT: 拒绝事件审计日志验证\n   \n   c) Process 适配器（test_process_security_adapter.gd）：\n      - ALLOW: 白名单命令（开发模式）\n      - DENY: 安全模式阻止、非白名单命令、危险参数、超时\n      - SENSITIVE: 参数脱敏验证（密码、Token）\n      - MODE: 安全模式/测试模式切换验证\n      - AUDIT: 审计日志无敏感数据\n   \n   d) 集成测试（test_security_integration.gd）：\n      - 多适配器协作场景\n      - 安全策略一致性验证\n      - 性能基准测试（100ms 阈值）\n   \n   e) 审计合规测试（test_audit_log_compliance.gd）：\n      - JSONL 格式验证\n      - 五字段完整性检查\n      - Action 命名符合 ADR-0004\n      - 敏感数据泄露检测\n\n3. CI 集成：\n   - 作业：godot-e2e\n   - 命令：py -3 scripts/python/run_gdunit.py --suite security --headless\n   - 超时：180s\n   - 失败阈值：任何测试失败即阻止合并\n   - 工件：logs/e2e/<date>/security-*.txt, security-audit.jsonl\n\n测试数据管理：\n- 测试审计日志路径：logs/ci/test/security-audit-test.jsonl\n- 测试后清理：before_test() 删除旧日志\n- 隔离性：每个测试使用独立 auditLogPath\n\n性能要求：\n- 单测试执行时间：≤ 100ms（P95）\n- 完整套件执行时间：≤ 5s（包含 URL 11 + File 15 + Process 12 + Integration 5 + Audit 3 = 46 tests）\n- 内存占用：≤ 50MB（Godot headless 模式）",
            "status": "done",
            "testStrategy": "测试覆盖目标：\n总计：46 tests\n- URL 适配器：11 tests [OK]（已完成）\n- File 适配器：15 tests ⏳（待创建）\n- Process 适配器：12 tests ⏳（待创建）\n- 集成测试：5 tests ⏳（待创建）\n- 审计合规：3 tests ⏳（待创建）\n\n通过标准：\n- 100% 测试通过率\n- 0 flaky tests\n- 0 timeout\n- 审计日志格式合规\n- 性能阈值达标（P95 ≤ 100ms）",
            "parentId": "8",
            "implementationNotes": "文件清单（待创建）：\n- Tests.Godot/tests/Security/Hard/test_file_security_adapter.gd\n- Tests.Godot/tests/Security/Hard/test_process_security_adapter.gd\n- Tests.Godot/tests/Security/Hard/test_security_integration.gd\n- Tests.Godot/tests/Security/Hard/test_audit_log_compliance.gd\n\nGdUnit4 测试模板：\n```gdscript\nextends GdUnitTestSuite\n\nconst SecurityFileAdapterFactory = preload(\"res://Game.Godot/Adapters/Security/security_file_adapter_factory.gd\")\n\nfunc before_test() -> void:\n    # 清理测试审计日志\n    var test_log_path := \"logs/ci/test/security-audit-test.jsonl\"\n    if FileAccess.file_exists(test_log_path):\n        DirAccess.remove_absolute(test_log_path)\n\n## Test ALLOW scenario: res:// read access\nfunc test_allows_res_read_valid_file() -> void:\n    var adapter = SecurityFileAdapterFactory.create_with_defaults(null)\n    var result: bool = adapter.IsPathAllowed(\"res://icon.svg\", FileAccess.READ)\n    assert_bool(result).is_true()\n```\n\nCI 运行命令：\n```bash\npy -3 scripts/python/run_gdunit.py \\\n  --godot-bin \"C:\\Godot\\Godot_v4.5.1-stable_mono_win64_console.exe\" \\\n  --project Tests.Godot \\\n  --add tests/Security/Hard \\\n  --timeout-sec 180\n```",
            "updatedAt": "2025-12-13T10:43:18.951Z"
          },
          {
            "id": 6,
            "title": "Wire SecurityUrlAdapter into Godot Hard tests",
            "description": "将 SecurityUrlAdapter 以可被 GDScript 使用的方式暴露给 Tests.Godot，让 test_url_security_adapter.gd 通过 allow/deny/invalid/SSRF 四态覆盖 ADR-0019 要求。",
            "dependencies": [
              1
            ],
            "details": "实现目标：\n- 保持 xUnit SecurityAdapterTests 作为 SSoT（Single Source of Truth）\n- 创建 Godot C# ↔ GDScript 互操作层\n- 实现 GdUnit4 测试套件覆盖 ADR-0019 安全要求\n- 解决跨语言边界的所有技术障碍\n- 确保 100% 测试通过率（11/11 tests）\n\n实现成果（已完成）：\n[OK] 1. 创建互操作层文件：\n   - SecurityUrlAdapterFactory.cs（C# 工厂类）\n   - security_url_adapter_factory.gd（GDScript 包装器）\n   - UrlValidationResult.cs（结果类支持索引访问）\n\n[OK] 2. 解决 6 个 Godot C# ↔ GDScript 互操作性问题：\n   \n   问题 1：工厂方法返回接口类型\n   - 现象：返回 ISecurityUrlValidator 导致 GDScript 无法识别\n   - 解决：改为返回具体类型 SecurityUrlAdapter\n   - 文件：SecurityUrlAdapterFactory.cs\n   \n   问题 2：ValidateAndAudit 返回元组\n   - 现象：C# 元组 (bool, string?) 无法跨语言边界传递\n   - 解决：创建 UrlValidationResult 类支持 Get(int index) 方法\n   - 文件：UrlValidationResult.cs（新建）\n   \n   问题 3：C# 索引器不导出到 GDScript\n   - 现象：this[int index] 索引器不生成 Godot 绑定\n   - 解决：添加显式 Get(int index) 方法\n   - 文件：UrlValidationResult.cs line 67\n   \n   问题 4：AllowedHosts 返回接口类型\n   - 现象：返回 IReadOnlyList<string>? 导致 GDScript 无法访问\n   - 解决：显式接口实现 + 公共属性返回 Godot.Collections.Array\n   - 文件：SecurityUrlAdapter.cs lines 62-89\n   \n   问题 5：命名空间冲突\n   - 现象：Game.Godot 命名空间与 Godot 命名空间冲突\n   - 解决：使用 global::Godot.Collections.Array 绕过命名空间解析\n   - 文件：SecurityUrlAdapter.cs lines 75, 82\n   \n   问题 6：GDScript Array API 差异\n   - 现象：GDScript Array 使用 size() 方法而非 Count 属性\n   - 解决：修改测试使用 .size() 替代 .Count\n   - 文件：test_url_security_adapter.gd line 156\n\n[OK] 3. 核心互操作模式（可复用到 File/Process 适配器）：\n   a) 显式接口实现模式：\n      ```csharp\n      // 显式实现 - 满足 Core 层接口契约\n      IReadOnlyList<string>? ISecurityUrlValidator.AllowedHosts => _allowedHosts;\n      \n      // 公共属性 - GDScript 可访问\n      public global::Godot.Collections.Array? AllowedHosts\n      {\n          get { /* 转换逻辑 */ }\n      }\n      ```\n   \n   b) RefCounted 继承：\n      - 所有适配器继承 RefCounted 确保 GDScript 可调用\n   \n   c) 工厂模式：\n      - 返回具体类型而非接口\n      - 提供多种创建方法（WithWhitelist, WithSsrfProtection, FromGodotArray）\n   \n   d) 结果类模式：\n      - 使用专用类替代元组\n      - 提供 Get(int index) 方法支持索引访问\n      - 支持属性访问（IsAllowed, RejectionReason）\n   \n   e) 命名空间处理：\n      - 使用 global:: 前缀避免命名空间冲突\n      - 文件命名空间保持 Game.Godot.Adapters.Security\n   \n   f) GDScript API 适配：\n      - Array 使用 size() 而非 Count\n      - Dictionary 使用 has() 而非 ContainsKey\n      - String 使用 length() 而非 Length\n\n[OK] 4. 测试覆盖（11 tests, 100% pass）：\n   \n   ALLOW 场景（2 tests）：\n   - test_allows_whitelisted_https_url - 白名单 HTTPS 通过\n   \n   DENY 场景（6 tests）：\n   - test_rejects_http_scheme - HTTP scheme 拒绝\n   - test_rejects_dangerous_schemes - 危险 scheme 阻止\n   - test_rejects_non_whitelisted_domain - 非白名单域名拒绝\n   - test_rejects_all_urls_when_whitelist_null - SSRF 防护（null）\n   - test_rejects_all_urls_when_whitelist_empty - SSRF 防护（空）\n   - test_rejects_null_or_empty_url - null/空 URL 拒绝\n   \n   INVALID 场景（1 test）：\n   - test_rejects_invalid_uri_format - 无效 URI 格式\n   \n   AUDIT 场景（2 tests）：\n   - test_exposes_allowed_hosts_property - AllowedHosts 属性暴露\n   - test_null_whitelist_exposes_null_property - null 白名单暴露\n   - test_audit_log_written_on_rejection - 审计日志创建\n\n[OK] 5. ADR-0019 安全合规验证：\n   - [OK] HTTPS-only 强制执行\n   - [OK] 白名单域名验证\n   - [OK] 危险 scheme 阻止（javascript:, file:, data:, blob:）\n   - [OK] SSRF 防护（null/空白名单拒绝所有 URL）\n   - [OK] 审计日志记录（security-audit.jsonl）\n   - [OK] 白名单配置暴露（AllowedHosts 属性）\n\n[OK] 6. CI 集成：\n   - 作业：godot-e2e\n   - 命令：py -3 scripts/python/run_gdunit.py --suite security\n   - 状态：11/11 tests PASSED (537ms)\n   - 退出码：0\n   - 工件：logs/e2e/2025-12-10/gdunit-console.txt\n\n技术债务：\n[WARN] 审计日志路径警告（非阻塞）：\n- 现象：部分测试传入 null auditLogPath 导致 \"Failed to write audit log: The value cannot be an empty string\" 警告\n- 影响：不影响测试通过，审计功能在提供正确路径时正常工作\n- 修复：可选优化，为所有测试提供有效 auditLogPath\n\n知识沉淀（适用于后续 File/Process 适配器）：\n1. 显式接口实现是关键模式 - 同时满足架构分层和互操作性\n2. 工厂方法必须返回具体类型 - GDScript 无法识别接口\n3. 避免元组/索引器 - 使用专用结果类 + Get() 方法\n4. 注意命名空间冲突 - 使用 global:: 前缀\n5. 适配 GDScript API 差异 - Array.size(), Dictionary.has() 等\n6. RefCounted 继承是必需的 - 确保 GDScript 可调用",
            "status": "done",
            "testStrategy": "双重测试策略（已完成）：\n\n1. xUnit 单元测试（SSoT）：\n   - 文件：Game.Core.Tests/Services/SecurityAdapterTests.cs\n   - 覆盖：纯 C# 安全契约验证\n   - 运行：dotnet test Game.Core.Tests/Game.Core.Tests.csproj -c Debug\n   - 状态：[OK] 通过\n\n2. GdUnit4 集成测试：\n   - 文件：Tests.Godot/tests/Security/Hard/test_url_security_adapter.gd\n   - 覆盖：11 tests，allow/deny/invalid/SSRF 四态\n   - 运行：py -3 scripts/python/run_gdunit.py --suite security\n   - 状态：[OK] 11/11 PASSED (537ms)\n\n测试结果汇总：\n- 总计：11 tests\n- 通过：11 tests (100%)\n- 失败：0\n- 超时：0\n- Flaky：0\n- 执行时间：537ms\n- 退出码：0",
            "parentId": "8",
            "updatedAt": "2025-12-10T08:00:00.000Z",
            "implementationNotes": "完整文件清单（已实现）：\n\n核心层（Game.Core）：\n- Game.Core/Interfaces/ISecurityUrlValidator.cs（接口定义）\n  Lines 30-48: 接口契约（AllowedHosts, IsUrlAllowed, ValidateAndAudit）\n\n适配层（Tests.Godot/Game.Godot/Adapters/Security）：\n- SecurityUrlAdapter.cs（主适配器实现）\n  Lines 62-89: AllowedHosts 显式接口实现 + Godot.Collections.Array 公共属性\n  Lines 92-96: IsUrlAllowed 简单验证\n  Lines 101-126: ValidateAndAudit 验证 + 审计\n  Lines 134-190: ValidateCore 核心验证逻辑\n  Lines 198-224: WriteAuditLog 审计日志写入\n\n- SecurityUrlAdapterFactory.cs（工厂类）\n  Lines 31-34: CreateWithWhitelist 白名单配置\n  Lines 42-45: CreateWithSsrfProtection SSRF 防护\n  Lines 54-57: CreateForTesting 测试配置\n  Lines 65-86: CreateFromGodotArray Godot 数组转换\n\n- UrlValidationResult.cs（结果类）\n  Lines 34-38: 构造函数\n  Lines 47-58: 索引器实现\n  Lines 67-70: Get(int index) 显式方法\n\n- security_url_adapter_factory.gd（GDScript 包装器）\n  Lines 5-35: 工厂方法 GDScript 绑定\n\n测试层（Tests.Godot/tests/Security/Hard）：\n- test_url_security_adapter.gd（GdUnit4 测试套件）\n  Lines 22-32: test_allows_whitelisted_https_url\n  Lines 35-46: test_rejects_http_scheme\n  Lines 49-67: test_rejects_dangerous_schemes\n  Lines 70-85: test_rejects_non_whitelisted_domain\n  Lines 88-99: test_rejects_all_urls_when_whitelist_null\n  Lines 102-111: test_rejects_all_urls_when_whitelist_empty\n  Lines 114-128: test_rejects_invalid_uri_format\n  Lines 131-146: test_rejects_null_or_empty_url\n  Lines 149-156: test_exposes_allowed_hosts_property\n  Lines 159-164: test_null_whitelist_exposes_null_property\n  Lines 169-184: test_audit_log_written_on_rejection\n\n审计日志输出（logs/e2e/2025-12-10）：\n- gdunit-console.txt（测试执行日志）\n  Line 56: Statistics: 11 test cases | 0 errors | 0 failures | 0 flaky | 0 skipped | 0 orphans | PASSED 537ms\n  Line 65: Exit code: 0\n\n关键代码片段：\n\n1. 显式接口实现（SecurityUrlAdapter.cs:62-89）：\n```csharp\n/// <summary>\n/// Explicit interface implementation - returns IReadOnlyList to satisfy interface contract.\n/// GDScript code should access the public AllowedHosts property instead.\n/// </summary>\nIReadOnlyList<string>? ISecurityUrlValidator.AllowedHosts => _allowedHosts;\n\n/// <summary>\n/// Public property for GDScript access - returns Godot.Collections.Array.\n/// </summary>\npublic global::Godot.Collections.Array? AllowedHosts\n{\n    get\n    {\n        if (_allowedHosts == null)\n            return null;\n\n        var result = new global::Godot.Collections.Array();\n        foreach (var host in _allowedHosts)\n        {\n            result.Add(host);\n        }\n        return result;\n    }\n}\n```\n\n2. GDScript 包装器（security_url_adapter_factory.gd:14-22）：\n```gdscript\nstatic func create_with_whitelist(allowed_hosts: Array, audit_log_path: String = \"\") -> RefCounted:\n\tvar factory_class = load(\"res://Game.Godot/Adapters/Security/SecurityUrlAdapterFactory.cs\")\n\tvar factory = factory_class.new()\n\tif audit_log_path == \"\":\n\t\treturn factory.CreateWithWhitelist(allowed_hosts, null)\n\telse:\n\t\treturn factory.CreateWithWhitelist(allowed_hosts, audit_log_path)\n```\n\n3. 测试示例（test_url_security_adapter.gd:149-156）：\n```gdscript\nfunc test_exposes_allowed_hosts_property() -> void:\n\tvar allowed_hosts := [\"example.com\", \"api.example.com\"]\n\tvar adapter = SecurityUrlAdapterFactory.create_with_whitelist(allowed_hosts, null)\n\t\n\tvar exposed_hosts = adapter.AllowedHosts\n\tassert_object(exposed_hosts).is_not_null()\n\tassert_int(exposed_hosts.size()).is_equal(2)  # 使用 size() 而非 Count\n```"
          }
        ],
        "adrRefs": [
          "ADR-0019",
          "ADR-0006",
          "ADR-0005",
          "ADR-0011",
          "ADR-0019 (Security Baseline)",
          "ADR-0007 (Ports and Adapters)",
          "ADR-0004 (Event Bus)",
          "ADR-0011 (Windows-only)"
        ]
      },
      {
        "id": "9",
        "adrRefs": [
          "ADR-0019",
          "ADR-0004",
          "ADR-0005",
          "ADR-0018"
        ],
        "title": "GameLoop 安全审计基线与任务映射收口",
        "description": "根据最新的 GameLoop 安全审计报告（logs/security-audit-gameloop.*）和 cifix.txt，对照 ADR-0019/0004/0005/0018 重新梳理 F001–F007，区分 T2 阶段必须完成与 NG 安全 backlog 的工作，并在 tasks_back.json / tasks_gameplay.json 中补齐 adr_refs/chapter_refs/overlay_refs/test_refs，使后续审计与 task_links_validate 以统一口径运行。",
        "status": "done",
        "priority": "high",
        "dependencies": [
          "1"
        ],
        "details": "Story: PH16-GAMELOOP-SECURITY-BASELINE\nADR Refs: ADR-0019; ADR-0004; ADR-0005; ADR-0018\nChapters: CH01; CH02; CH04; CH06; CH07\nTest Refs: logs/security-audit-gameloop.json; logs/SECURITY_AUDIT_GAMELOOP_REPORT.md; cifix.txt\nAcceptance: SECURITY_AUDIT_GAMELOOP_REPORT.md 以 ADR-0019 为基线，明确区分 T2_BLOCKING 与 NG_BACKLOG 安全问题，并与 cifix.txt 中的技术债记录一致。; F001/F002/F005 至少映射到一条 T2 相关 NG/GM 任务，F003/F004/F006/F007 映射到 NG 安全或架构 backlog 任务，且在 tasks_back.json / tasks_gameplay.json 中补齐 adr_refs/chapter_refs/overlay_refs/test_refs。; 运行 py -3 scripts/python/task_links_validate.py 时，GameLoop 相关任务不再因为 ADR/Chapter 映射或缺失 Test-Refs 报错。\nTest Strategy: 人工对比 logs/security-audit-gameloop.* 与 tasks_back.json / tasks_gameplay.json，确认每条 F00x 至少有一条对应任务可追踪。; 运行 task_links_validate.py 与 check_tasks_all_refs.py，确认新增/调整后的 NG/GM 任务全部通过回链校验。\nLabels: security; gameloop; docs; audit\nOwner: architecture\nLayer: docs",
        "testStrategy": "人工对比 logs/security-audit-gameloop.* 与 tasks_back.json / tasks_gameplay.json，确认每条 F00x 至少有一条对应任务可追踪。\n运行 task_links_validate.py 与 check_tasks_all_refs.py，确认新增/调整后的 NG/GM 任务全部通过回链校验。",
        "subtasks": [],
        "updatedAt": "2025-12-08T07:11:29.975Z"
      },
      {
        "id": "10",
        "title": "GameLoop SaveIdValue 值对象与白名单校验",
        "description": "在 Game.Core 中为 GameLoop 引入 SaveIdValue 值对象（或等价验证器），实现基于 ADR-0019 的白名单规则（仅允许 [a-zA-Z0-9_-] 且长度 1-64），并在 GameTurnState/GameTurnSystem 与 GameLoop 相关合约中统一使用该类型；同时新增 SaveId 安全向单元测试，覆盖非法输入与边界值。",
        "status": "done",
        "priority": "high",
        "dependencies": [
          "9"
        ],
        "details": "Story: PH16-GAMELOOP-SAVEID-VALUE\nADR Refs: ADR-0019; ADR-0004; ADR-0005; ADR-0018\nChapters: CH01; CH02; CH04; CH06; CH07\nTest Refs: Game.Core/Domain/Turn/SaveIdValue.cs; Game.Core.Tests/Domain/SaveIdValueTests.cs; Game.Core.Tests/Domain/GameTurnSystemTests.cs; Game.Core.Tests/Domain/GameLoopTests.cs\nAcceptance: Game.Core/Domain/Turn 下新增 SaveIdValue（或等价类型），实现 [a-zA-Z0-9_-]{1,64} 的白名单校验，非法输入抛出 ArgumentException。; GameTurnState / GameTurnSystem 在内部使用 SaveIdValue 作为 SaveId 的入口类型，确保后续事件与存储只接受经过校验的值。; Game.Core.Tests 中新增 SaveIdValueTests 与针对无效 SaveId 的 GameTurnSystem / GameLoop 测试，覆盖空字符串、超长、SQL 片段、路径遍历等典型攻击向量。; dotnet test Game.Core.Tests 在本地与 CI 均可通过，且与 PRD 3.0.3 T2 可玩性场景流描述一致。\nTest Strategy: 单元测试：在 SaveIdValueTests 中穷举典型非法/合法输入，验证构造/工厂方法的行为与异常信息。; 集成测试：在 GameTurnSystemTests 与 GameLoopTests 中增加使用非法 SaveId 的路径，验证系统拒绝不符合白名单的存档槽 ID。\nLabels: security; gameloop; core; t2\nOwner: architecture\nLayer: core",
        "testStrategy": "单元测试：在 SaveIdValueTests 中穷举典型非法/合法输入，验证构造/工厂方法的行为与异常信息。\n集成测试：在 GameTurnSystemTests 与 GameLoopTests 中增加使用非法 SaveId 的路径，验证系统拒绝不符合白名单的存档槽 ID。",
        "subtasks": [],
        "adrRefs": [
          "ADR-0019",
          "ADR-0004",
          "ADR-0005",
          "ADR-0018"
        ]
      },
      {
        "id": "11",
        "title": "SqliteDataStore 路径校验与插件后端安全收紧",
        "description": "在 Game.Godot/Adapters/SqliteDataStore 中增强路径与扩展名校验：对 user:// 路径进行规范化后再做前缀与 .. 检查，增加 .db/.sqlite/.sqlite3 等扩展名白名单，并为已有 ValidatePath 逻辑补充文件大小上限检查；同时通过环境变量限制 plugin backend 的启用范围（如仅在开发环境允许），将 plugin backend 风险收敛为受控技术债。",
        "status": "in-progress",
        "priority": "medium",
        "dependencies": [
          "8"
        ],
        "details": "Story: PH06-GAMELOOP-SQLITE-PATH-HARDENING\nADR Refs: ADR-0019; ADR-0006; ADR-0005; ADR-0011\nChapters: CH02; CH05; CH07; CH10\nTest Refs: Game.Godot/Adapters/SqliteDataStore.cs; logs/ci/<date>/security-audit.jsonl\nAcceptance: SqliteDataStore 对传入路径在检查前统一规范化分隔符，严格限制为 user:// 前缀并拒绝任何包含 .. 的路径。; SqliteDataStore 增加数据库文件扩展名白名单（如 .db/.sqlite/.sqlite3），非法扩展名会被拒绝并记录审计日志。; 针对已有数据库文件增加简单的大小上限检查（防 DoS），超限时抛出安全异常并写入 security-audit.jsonl。; 通过环境变量（例如 ALLOW_PLUGIN_BACKEND）或等价方案，将 plugin backend 限定在开发/实验环境，生产默认使用 managed backend，并在文档中明确记录。\nTest Strategy: 单元/集成测试：为 SqliteDataStore 增加路径与扩展名相关的测试用例，覆盖非法前缀、..、非法扩展名、超大文件等场景。; 安全审计：在启用/禁用 plugin backend 的不同配置下运行最小数据库操作，验证 security-audit.jsonl 中有预期的审计条目。\nLabels: security; sqlite; godot; adapter\nOwner: architecture\nLayer: adapter",
        "testStrategy": "单元/集成测试：为 SqliteDataStore 增加路径与扩展名相关的测试用例，覆盖非法前缀、..、非法扩展名、超大文件等场景。\n安全审计：在启用/禁用 plugin backend 的不同配置下运行最小数据库操作，验证 security-audit.jsonl 中有预期的审计条目。",
        "complexity": 5,
        "recommendedSubtasks": 3,
        "expansionPrompt": "Break down this task with a focus on setup core game loop.",
        "subtasks": [],
        "adrRefs": [
          "ADR-0019",
          "ADR-0006",
          "ADR-0005",
          "ADR-0011"
        ]
      },
      {
        "id": "12",
        "title": "GodotSQLiteDatabase 错误脱敏与审计挂钩",
        "description": "在 Game.Godot/Adapters/Db/GodotSQLiteDatabase 中按 ADR-0019 要求改造错误处理：开发环境保留详细异常信息方便排查；生产环境仅抛出脱敏后的通用错误消息，并将包含路径/SQL 明细的诊断信息写入安全审计日志或内部日志文件；同时为 OpenAsync/Execute* 等路径补充最小测试或 smoke 验证。",
        "status": "pending",
        "priority": "low",
        "dependencies": [
          "11"
        ],
        "details": "Story: PH06-GAMELOOP-DB-ERROR-AND-AUDIT\nADR Refs: ADR-0019; ADR-0006; ADR-0005; ADR-0011\nChapters: CH02; CH05; CH07; CH10\nTest Refs: Game.Godot/Adapters/Db/GodotSQLiteDatabase.cs; logs/ci/<date>/security-audit.jsonl\nAcceptance: GodotSQLiteDatabase 在 DEBUG 构建下仍然抛出包含路径/SQL 的详细异常，方便开发调试。; 在 Release/CI 环境下，同一代码路径仅向调用方暴露脱敏后的通用错误消息，详细路径与 SQL 片段被写入受控的审计/诊断日志。; 新增或扩展现有 smoke/集成测试，验证在数据库打开失败、SQL 执行失败等典型失败场景下，错误信息不会直接泄露敏感实现细节。\nTest Strategy: 环境对比测试：在 DEBUG 与 Release 配置下分别触发数据库异常，验证对调用方的异常消息差异以及 security-audit.jsonl 中的记录行为。; CI 验证：在 windows-quality-gate 或等价工作流中加入一次最小化的 GodotSQLiteDatabase smoke 调用，确保改造后不会破坏现有管线。\nLabels: security; sqlite; godot; error-handling\nOwner: architecture\nLayer: adapter",
        "testStrategy": "环境对比测试：在 DEBUG 与 Release 配置下分别触发数据库异常，验证对调用方的异常消息差异以及 security-audit.jsonl 中的记录行为。\nCI 验证：在 windows-quality-gate 或等价工作流中加入一次最小化的 GodotSQLiteDatabase smoke 调用，确保改造后不会破坏现有管线。",
        "complexity": 5,
        "recommendedSubtasks": 3,
        "expansionPrompt": "Break down this task with a focus on develop event system.",
        "subtasks": [],
        "adrRefs": [
          "ADR-0019",
          "ADR-0006",
          "ADR-0005",
          "ADR-0011"
        ]
      }
    ],
    "metadata": {
      "version": "1.0.0",
      "lastModified": "2025-12-13T10:43:18.954Z",
      "taskCount": 12,
      "completedCount": 7,
      "tags": [
        "master"
      ]
    }
  },
  "feature-docs": {
    "tasks": [
      {
        "id": 1,
        "title": "整理 newguild 首个垂直切片 PRD 与 Overlay 映射",
        "description": "基于现有 ADR 与 Phase 文档，为 newguild 定义首个可玩的垂直切片（例如基础公会管理循环），并将 Story 对齐到 PRD-<PRODUCT> / overlays/08 中的功能纵切文档。产出：一份最小 PRD 片段、对应 overlays 目录与 Test-Refs 协议。",
        "status": "pending",
        "priority": "high",
        "dependencies": [],
        "details": "Story: PRD-NEWGUILD-VS-0001\nADR Refs: ADR-0018; ADR-0004; ADR-0005; ADR-0023; ADR-0011\nChapters: CH01; CH04; CH05; CH06; CH07; CH10\nOverlays: docs/architecture/overlays/PRD-Guild-Manager/08/_index.md; docs/architecture/overlays/PRD-Guild-Manager/08/08-功能纵切-公会管理器.md; docs/architecture/overlays/PRD-Guild-Manager/08/ACCEPTANCE_CHECKLIST.md\nAcceptance: 存在一份针对 newguild 的最小 PRD 片段（含输入/输出/状态/存储与非功能约束），并显式引用 ADR-0018/0004/0005/0023/0011。; 在 overlays/PRD-*/08 下新增或调整功能纵切文档，严格遵守 08 章只引用 01/02/03 口径的规则（不复制阈值）。; 每个 Story 至少关联一条 Test-Ref（xUnit 或 GdUnit4），并在文档脚注中列出。\nTest Strategy: 文档审阅：由架构负责人确认 PRD 与 ADR/Phase 一致性。; 链接校验：任务/回链校验脚本通过（task-links-validate）。\nLabels: prd; vertical-slice; docs; architecture\nOwner: architecture\nLayer: docs",
        "testStrategy": "文档审阅：由架构负责人确认 PRD 与 ADR/Phase 一致性。\n链接校验：任务/回链校验脚本通过（task-links-validate）。"
      },
      {
        "id": 5,
        "title": "Python 版 headless smoke 封装与 strict 模式开关",
        "description": "根据 Phase-12-Headless-Smoke-Backlog.md B1/B2，在当前 Godot + C# 模板中实现 Python 版 headless smoke 封装脚本（替代/补充 PowerShell 版本），并增加 strict 模式：严格依赖 [TEMPLATE_SMOKE_READY]/[DB] opened marker 决定通过与否。",
        "status": "pending",
        "priority": "high",
        "dependencies": [
          1
        ],
        "details": "Story: PH12-BACKLOG-B1-B2\nADR Refs: ADR-0005; ADR-0011; ADR-0018; ADR-0020\nChapters: CH01; CH06; CH07; CH10\nTest Refs: logs/ci/<date>/smoke/headless.log; logs/ci/<date>/smoke/selfcheck-summary.json\nAcceptance: 新增 scripts/python/smoke_headless.py（或等价脚本），支持 --godot-bin/--scene/--timeout-sec/--project-path 参数，并在 Windows 上可直接运行。; 非 strict 模式下，脚本行为与现有 PowerShell 版本等价，输出写入 logs/ci/<date>/smoke/**，并保留宽松判定。; strict 模式下，仅当日志包含 [TEMPLATE_SMOKE_READY] 或 [DB] opened 时返回 0，否则返回非零并在日志中标记为 strict-failed。; ci-windows.yml 或 windows-quality-gate.yml 至少提供一条注释示例，展示如何在受保护分支启用 strict 模式。\nTest Strategy: 本地运行：在 Windows 环境下通过 dev_cli.py 调用 Python 版 smoke，验证日志与退出码。; CI 演练：在非受保护分支上打开 strict 模式，观察 smoke 失败时的门禁行为与日志输出。\nLabels: ci; smoke; godot; python; headless\nOwner: architecture\nLayer: ci",
        "testStrategy": "本地运行：在 Windows 环境下通过 dev_cli.py 调用 Python 版 smoke，验证日志与退出码。\nCI 演练：在非受保护分支上打开 strict 模式，观察 smoke 失败时的门禁行为与日志输出。"
      },
      {
        "id": 7,
        "title": "扩展 quality_gates.py 覆盖率阈值与 GdUnit4 集成",
        "description": "承接 Phase-13-Quality-Gates-Script.md 与 Backlog：将 xUnit 覆盖率门禁提升到蓝图标准（行≥90%、分支≥85%，可由环境变量覆盖），并把关键 GdUnit4 集合（Adapters+Security 小集）通过 quality_gates.py 聚合输出到统一 summary，以便在 CI 中统一判定。",
        "status": "pending",
        "priority": "high",
        "dependencies": [
          5
        ],
        "details": "Story: PH13-BACKLOG-B1-B2-B5\nADR Refs: ADR-0005; ADR-0015; ADR-0018; ADR-0020\nChapters: CH01; CH06; CH07; CH09\nTest Refs: logs/ci/<date>/unit/coverage.json; logs/e2e/<date>/gdunit-hard/run-summary.json; logs/ci/<date>/quality-gates-summary.json\nAcceptance: scripts/python/run_dotnet.py 读取覆盖率结果并在 summary.json 中写入 lines/branches 与阈值配置（默认 90/85，可由环境变量覆盖）。; 当覆盖率低于阈值时，quality_gates.py 在 summary 中标记为 failed，并可配置为软/硬门禁（至少支持硬门禁）。; quality_gates.py 能调用 run_gdunit.py 或等价封装，执行 Adapters+Security 硬门禁集合，并在 quality-gates-summary.json 中汇总结果。; Windows Quality Gate 工作流调用 quality_gates.py all 时，能在 Step Summary 中清晰展示 dotnet 覆盖率与 GdUnit4 集合结果。\nTest Strategy: 本地模拟：手工降低测试覆盖率，验证 quality_gates.py 将其标记为 failed，并按配置返回非零 exit code。; CI 验证：在 PR 上运行 windows-quality-gate 工作流，观察 coverage 与 GdUnit4 结果是否在 Step Summary 与 artifacts 中正确展示。\nLabels: ci; quality-gates; coverage; gdunit\nOwner: architecture\nLayer: ci",
        "testStrategy": "本地模拟：手工降低测试覆盖率，验证 quality_gates.py 将其标记为 failed，并按配置返回非零 exit code。\nCI 验证：在 PR 上运行 windows-quality-gate 工作流，观察 coverage 与 GdUnit4 结果是否在 Step Summary 与 artifacts 中正确展示。"
      }
    ],
    "metadata": {
      "created": "2025-12-05T13:26:03.323Z",
      "updated": "2025-12-05T13:26:03.323Z",
      "description": "Tasks for feature-docs context"
    }
  }
}
